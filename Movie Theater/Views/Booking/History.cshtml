@model IEnumerable<Movie_Theater.Models.Order>

@{
    ViewBag.Title = "History";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>History</h2>

<div class="wrapper-container">
    <table class="table">
        <tr>
            <th>
                Phim
            </th>
            <th>
                Ngày Đặt
            </th>
            <th>
                Số Tiền
            </th>
            <th>
                Ghế
            </th>
            <th>
                Rạp
            </th>
            <th>
                Trạng Thái
            </th>
            <th></th>
        </tr>

        @foreach (var itemGroup in Model.GroupBy(x => x.Id))
        {
            var item = itemGroup.First();

            <tr>
                <td>
                    @{
                        var movieTitle = item.Tickets.First().Showing.Movie.Title;
                    }
                    @movieTitle
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.OrderDate)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.Total)
                </td>
                <td>
                    @string.Join(" | ", item.Tickets.Select(ticket => ticket.Seat))
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.Tickets.First().Showing.Theatre.Name)
                </td>
                <td id="order-status-@item.Id">
                    @Html.DisplayFor(modelItem => item.Status)
                </td>
                <td>
                    @if (item.Status == Movie_Theater.Models.OrderStatus.Pending)
                    {
                        <button type="button" class="btn btn-danger cancel-button" data-order-id="@item.Id">Hủy Bỏ</button>
                    }
                </td>
            </tr>
        }

    </table>
</div>
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script>
    $(document).ready(function () {
        $('.cancel-button').click(function () {
            var button = $(this);
            var orderId = button.attr('data-order-id');

            if (confirm('Bạn có chắc chắn muốn hủy đơn hàng này?')) {
                $.ajax({
                    url: '/Orders/Cancel',
                    type: 'POST',
                    data: { OrderId: orderId },
                    dataType: 'json',
                    success: function (data) {
                        if (data.success) {
                            alert('Đơn hàng đã được hủy thành công!');
                            $('#order-status-' + orderId).text('Cancelled');
                            button.remove();
                        } else {
                            alert(data.error);
                        }
                    },
                    error: function () {
                        alert('Lỗi khi hủy đơn hàng!');
                    }
                });
            }
        });
    });
</script>

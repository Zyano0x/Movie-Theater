@model Movie_Theater.Models.Order
@using Movie_Theater.Models
@{
    ViewBag.Title = "Details";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<style>
    .table-bordered > thead > tr > td, .table-bordered > thead > tr > th {
        border-bottom-width: 0px;
    }

    .table > tbody > tr > th:last-child, .table > tbody > tr > td:last-child {
        display: revert;
    }
</style>
<div class="wrapper-container" style=" background-color: #2f353b;">
    <div>
        <h5 class="heading"><i class="fa-solid fa-hand-holding-dollar"></i> Thanh Toán</h5>
        <hr />
        @*<p>Trạng thái: @Model.Status</p>*@
    </div>

    <table class="table table-bordered">
        <thead>
            <tr style="color: #f7c12f">
                <th class="col-md-3">
                    Phim
                </th>
                <th class="col-md-3">
                    Thời gian chiếu
                </th>
                <th class="col-md-2">
                    Giá vé
                </th>
                <th class="col-md-1">
                    Ghế
                </th>
                <th class="col-md-2">
                    Rạp
                </th>
                @if (Model.Status == OrderStatus.Pending)
                {
                    <th class="col-md-1"></th>
                }
            </tr>
        </thead>

        <tbody>
            @foreach (var tic in Model.Tickets)
            {
                <tr>
                    <td class="col-md-3">
                        @Html.DisplayFor(modelItem => tic.Showing.Movie.Title)
                    </td>
                    <td class="col-md-3">
                        @Html.DisplayFor(modelItem => tic.Showing.StartTime)
                    </td>
                    <td class="col-md-2">
                        @Html.DisplayFor(modelItem => tic.Price)
                    </td>
                    <td class="col-md-1">
                        @Html.DisplayFor(modelItem => tic.Seat)
                    </td>
                    <td class="col-md-2">
                        @Html.DisplayFor(modelItem => tic.Showing.Theatre.Name)
                    </td>
                    @if (Model.Status == OrderStatus.Pending)
                    {
                        <td class="col-md-1">
                            <button type="submit" class="btn btn-danger delete-btn font-weight-600" data-id="@tic.Id" style="margin: 5px 0;">Xóa</button>
                        </td>
                    }
                </tr>
            }
        </tbody>

    </table>

    <hr/>

    <table class="table table-sm table-bordered" style="width:100%">
        <tr style="color: #f7c12f">
            <th colspan="2" style="text-align:center">Tổng tiền</th>
        </tr>
        <tr>
            <td class="col-md-6">@Html.DisplayNameFor(model => model.Subtotal):</td>
            <td class="col-md-6"><span id="SubtotalValue">@Model.Subtotal.ToString("0.00") VND</span></td>
        </tr>
        <tr>
            <td class="col-md-6">@Html.DisplayNameFor(model => model.TaxAmount):</td>
            <td class="col-md-6"><span id="TaxAmountValue">@Model.TaxAmount.ToString("0.00") VND</span></td>
        </tr>
        <tr>
            <td class="col-md-6">@Html.DisplayNameFor(model => model.Total):</td>
            <td class="col-md-6" style="color: #f7c12f;"><span id="TotalValue">@Model.Total.ToString("0.00") VND</span></td>
        </tr>
    </table>
    <p class="text-align-end">
        @Html.ActionLink("Trở lại", "Index", null, new { @class = "btn btn-back font-weight-600", style = "margin-right: 5px; width: 111px;" })
        @if (Model.Status == OrderStatus.Pending)
        {
            @Html.ActionLink("Thêm ghế", "Edit", "Orders", new { OrderId = Model.Id }, new { @class = "btn btn-primary mr-2 white-color font-weight-600", style= "width: 111px; background-color: #f7c12f; border: unset;" })
            @Html.ActionLink("Thanh Toán", "Checkout", "Orders", new { OrderId = Model.Id }, new { @class = "btn btn-success white-color font-weight-600", style= "width: 111px; background-color: #f7c12f; border: unset;" })
        }
        @if (Model.Status == OrderStatus.Complete)
        {
            @Html.ActionLink("Hủy đặt vé", "Cancel", "Orders", new { OrderID = Model.Id }, new { @class = "btn btn-danger white-color font-weight-600" })
        }
    </p>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script>
    $(function () {
        $('.delete-btn').click(function (e) {
            e.preventDefault();
            var btn = $(this);
            var id = btn.data('id');

            if (confirm("Bạn chắc chắn muốn xóa ghế này?")) {
                $.ajax({
                    url: '/Tickets/Delete',
                    type: 'POST',
                    data: { id: id },
                    success: function (result) {
                        if (result.success) {
                            btn.closest('tr').remove(); // Remove the deleted row from the table

                            // Update the subtotal, tax amount, and total
                            var subtotal = parseFloat(result.subtotal);
                            var taxAmount = parseFloat(result.taxAmount);
                            var total = parseFloat(result.total);

                            $('#SubtotalValue').text(subtotal.toFixed(2));
                            $('#TaxAmountValue').text(taxAmount.toFixed(2));
                            $('#TotalValue').text(total.toFixed(2));
                        } else {
                            alert(result.message);
                        }
                    },
                    error: function () {
                        alert('An error occurred while deleting the record.');
                    }
                });
            }
        });
    });

</script>